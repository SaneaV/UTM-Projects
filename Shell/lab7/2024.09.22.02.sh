# 2) Скрипт untrash 
# a) Скрипту передается один параметр – имя файла, который нужно восстановить (без полного пути – только имя). 
# b) Скрипт по файлу trash.log должен найти все записи, содержащие в качестве имени файла переданный параметр, и выводить по одному на экран полные имена таких файлов с запросом подтверждения. 
# c) Если пользователь отвечает на подтверждение положительно, то предпринимается попытка восстановить файл по указанному полному пути (создать в соответствующем каталоге жесткую ссылку на файл из trash и удалить соответствующий файл из trash). Если каталога, указанного в полном пути к файлу, уже не существует, то файл восстанавливается в домашний каталог пользователя с выводом соответствующего сообщения.


#!/bin/bash

# Флаг для отслеживания того, был ли файл восстановлен
found=0

# Проверка наличия переданного аргумента (имени файла)
if [ $# -ne 1 ]; then
  echo "Error: You must pass a file name to recover."  # Если имя файла не передано, выводится ошибка
  exit 1  # Выход из скрипта с кодом 1 (ошибка)
fi

# Имя файла для восстановления
filename=$1  # Первый аргумент командной строки — это имя файла для восстановления

# Путь к лог-файлу
log_file="$HOME/trash.log"  # Лог-файл, где хранится информация об удалённых файлах

# Проверка существования лог-файла
if [ ! -f "$log_file" ]; then  # Если лог-файл не существует
  echo "Error: Log file '$log_file' not found."  # Сообщаем об ошибке
  exit 1  # Выход из скрипта
fi

# Путь к каталогу trash
trash_dir="$HOME/.trash"  # Каталог, где хранятся удалённые файлы

# Проверка существования каталога trash
if [ ! -d "$trash_dir" ]; then  # Если каталог корзины не существует
  echo "Error: Directory '$trash_dir' not found."  # Сообщаем об ошибке
  exit 1  # Выход из скрипта
fi

# Сохраняем строки, соответствующие имени файла, в массив
mapfile -t lines < <(grep -F "$filename" "$log_file")  # Ищем все строки в лог-файле, содержащие имя файла

# Проверка на пустой результат
if [ ${#lines[@]} -eq 0 ]; then  # Если массив пустой (файл не найден в лог-файле)
  echo "File not found"  # Сообщаем, что файл не найден
  exit 1  # Выход из скрипта
fi

# Перебор всех найденных строк
for line in "${lines[@]}"; do  # Цикл по каждой строке, найденной в лог-файле
  # Извлечение исходного пути файла и имени жесткой ссылки из строки
  original_path=$(echo "$line" | cut -d ':' -f 1)  # Исходный путь к файлу (до его удаления)
  link_name=$(echo "$line" | cut -d ':' -f 2)  # Имя файла в каталоге корзины (уникальное имя)

  # Запрос подтверждения у пользователя на восстановление
  echo "File found: $original_path"  # Сообщаем, что файл найден
  exec < /dev/tty  # Переключаем ввод для работы с терминалом
  read -p "Do you want to restore this file? (y/n): " answer  # Спрашиваем пользователя, нужно ли восстанавливать файл

  if [ "$answer" == "y" ]; then  # Если пользователь ответил "y" (yes)
    found=1  # Устанавливаем флаг, что файл восстановлен
    # Проверка, существует ли исходный каталог
    original_dir=$(dirname "$original_path")  # Получаем каталог, в котором был файл до удаления
    
    if [ -d "$original_dir" ]; then  # Если исходный каталог существует
      # Восстановление файла в исходное место
      ln "$trash_dir/$link_name" "$original_path"  # Создаём жесткую ссылку из файла в корзине в исходный путь
      echo "File '$filename' restored to original location: $original_path"  # Сообщаем о восстановлении
    else
      # Восстановление файла в домашний каталог, если исходного каталога больше нет
      ln "$trash_dir/$link_name" "$HOME/$filename"  # Создаём жесткую ссылку в домашний каталог
      echo "Source directory not found. File restored to home directory: $HOME/$filename"  # Сообщаем об изменении пути
    fi
    
    # Удаление жесткой ссылки из каталога trash
    rm "$trash_dir/$link_name"  # Удаляем файл из корзины
    echo "File removed from trash: $trash_dir/$link_name"  # Сообщаем об удалении файла из корзины
    
    # Удаление строки из лог-файла (удаляем запись о восстановленном файле)
    grep -Fxv "$line" "$log_file" > "$log_file.tmp" && mv "$log_file.tmp" "$log_file"  # Обновляем лог-файл, удаляя строку с восстановленным файлом
    echo "Log file updated, entry deleted."  # Сообщаем об успешном обновлении лог-файла
  fi
done

# Проверка, если ни один файл не был восстановлен
if [ $found -eq 0 ]; then  # Если флаг остался равным 0 (файл не восстановлен)
  echo "File not restored"  # Сообщаем пользователю, что файл не был восстановлен
fi

# Завершение работы скрипта
echo "Ending the script."  # Выводим сообщение о завершении работы скрипта

